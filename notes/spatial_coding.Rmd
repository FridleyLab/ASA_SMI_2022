---
title: "ASA SMI"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

Some packages that we need to load for analyses like `tidyverse` and `spatialTIME` available from CRAN.

```{r packages}
#make vector of packages to install and load
packages = c("tidyverse", "spatialTIME", "here")
#check if packages are installed and if not, install
install.packages(setdiff(packages, rownames(installed.packages())))
t = lapply(packages, require, character.only = T)
```

# Importing Data

The clinical data, per-cell spatial data, and sample summary data are in the `data/` subdirectory

```{r data_import}
#read clinical csv
clinical_data <- read.csv(here::here("data/deidentified_clinical.csv"))
head(clinical_data)
#read summary csv
sample_summary <- read.csv(here::here("data/deidentified_summary.csv"), sep="")
head(sample_summary)
#read spatial list
load(here::here("data/deidentified_example.RData"))
names(example_spatial_small)
```

# Create Multiplex ImmunoFlourescent (mif) Object 

spatialTIME functions use a custom `mif` object which can be created 
using the `create_mif()` function. 
The `mif` object has 6 slots storing the: 

* Clinical data which must contain:
  - a column whose column name matches one in the sample dataset.
* Sample summary data including counts/percentages of each positive cells
for each single or combination of markers and total number of cells for 
each core. In order to use `create_mif()` function this table must contain:
  - a column whose column name matches one in the clinical dataset
  - a column whose column name matches one in the spatial list.
* Spatial list (1 per each core):
  - This object should be a list object where each element of the list
  corresponds to a core and each element should be a  $n\times p$ 
  dataframe ($n$ = number of cells)  containing:
    1. a column name that matches a column name for the sample file 
    (for merging and potential downstream analysis linking to clinical
    variables),
    2. `XMin`, `XMax`, `YMin`, and `YMax` which defines the area that a
    cell occupies which is eventually used to assign a location for each
    cell with the x-position being the mean of the `XMin` and `XMax` and
    y-position being the mean of the `YMin` and `YMax`
    3. a set of columns that indicate whether a cell is positive to one
    or multiple markers.
* patient id:
  - a column name used to merge clinical and summary data
* sample_id:
  - a column name used to merge the spatial and summary data
* derived:
  - where all of the plots and spatial clustering measures are stored

# Creating MIF object

```{r ceate_mif_object}
# Make sure the variable types are the same for deidentified_id and 
# deidentified_sample in their corresponding datasets
x <- spatialTIME::create_mif(clinical_data = clinical_data %>%
                               mutate(deidentified_id = as.character(deidentified_id)),
                             sample_data = sample_summary %>%
                               mutate(deidentified_id = as.character(deidentified_id)),
                             spatial_list = example_spatial_small,
                             patient_id = "deidentified_id", sample_id = "deidentified_sample")

x #prints a summary of how many patients, samples, and spatial files are present

```

# Visualizing TMAs

```{r mif_plotting}
names_one <- c("CD3..CD8.","CD3..FOXP3.","CD3..Opal.570..Positive",
               "CD8..Opal.520..Positive","FOXP3..Opal.620..Positive", 
               "PDL1..Opal.540..Positive", "PD1..Opal.650..Positive")

names_two <- c("CD3..Opal.570..Positive","CD8..Opal.520..Positive",
               "FOXP3..Opal.620..Positive","PDL1..Opal.540..Positive",
               "PD1..Opal.650..Positive","CD3..CD8.","CD3..FOXP3.")

#add an element in the `derived` object position
x <- spatialTIME::plot_immunoflo(x, plot_title = "deidentified_sample",  
                                 mnames = names_one, cell_type = "Classifier.Label")
x[["derived"]][["spatial_plots"]][[4]]

# name order matters 
x <- spatialTIME::plot_immunoflo(x, plot_title = "deidentified_sample",  
                                 mnames = names_two, cell_type = "Classifier.Label")
x[["derived"]][["spatial_plots"]][[4]] +
  scale_color_manual(breaks = names_two, 
                     values = viridis::turbo(7),
                     labels = names_two %>%
                       gsub("..Opal.*", "+", .) %>% 
                       gsub("\\.\\.", "+", .) %>% 
                       gsub("\\.", "+", .))
  
```

